machine:
  environment:
    TERM: xterm-256color
    GOROOT: "/home/ubuntu/go"
    PATH: "/home/ubuntu/go/bin:$PATH"
    GOLANG_VERSION: 1.8beta1

dependencies:
  cache_directories:
    - "/home/ubuntu/.go"
  pre:
    - >
      if [[ ! -e "/home/ubuntu/.go/${GOLANG_VERSION}/bin/go" ]]; then
        cd /home/ubuntu
        curl https://storage.googleapis.com/golang/go${GOLANG_VERSION}.linux-amd64.tar.gz | tar -xz
        mkdir -p ~/.go
        cp -rp /home/ubuntu/go /home/ubuntu/.go/${GOLANG_VERSION}
      else
        cp -rp /home/ubuntu/.go/${GOLANG_VERSION} ~/go
      fi
    - go version
    - go get -u github.com/golang/lint/golint

test:
  override:
    - go test -v -race -coverprofile=coverage.txt -covermode=atomic .
  post:
    - bash <(curl -s https://codecov.io/bash)
    - test -z "$(gofmt -e -s -l -w $(find . -not -iwholename '*vendor*' -and -name '*.go' -print) | tee /dev/stderr)"
    - test -z "$(golint $(go list ./... | grep -v vendor) | tee /dev/stderr)"
    - go vet $(go list ./... | grep -v vendor)
